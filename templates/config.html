{% extends "base.html" %}

{% block content %}
<div class="form-container">
    <div class="bg-white shadow rounded-lg p-4">
        <h2 class="text-xl font-bold mb-4">Configuración</h2>
        
        <form id="configForm" class="space-y-4">
            <!-- Horario de Trabajo -->
            <div class="space-y-3">
                <h3 class="text-base font-semibold">Horario de Trabajo</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label for="work_start_time" class="block text-xs font-medium text-gray-700">Hora de Inicio</label>
                        <input type="time" id="work_start_time" name="work_start_time" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                    </div>
                    <div>
                        <label for="work_end_time" class="block text-xs font-medium text-gray-700">Hora de Fin</label>
                        <input type="time" id="work_end_time" name="work_end_time"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                    </div>
                </div>
            </div>

            <!-- Servicios -->
            <div class="space-y-3">
                <h3 class="text-base font-semibold">Servicios</h3>
                <div class="space-y-3">
                    <div>
                        <label for="default_service" class="block text-xs font-medium text-gray-700">Servicio Principal</label>
                        <input type="text" id="default_service" name="default_service"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                    </div>
                    <div>
                        <label for="ooo_service" class="block text-xs font-medium text-gray-700">Servicio Fuera de Oficina</label>
                        <input type="text" id="ooo_service" name="ooo_service"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                    </div>
                    <div>
                        <label for="focus_time_service" class="block text-xs font-medium text-gray-700">Servicio Focus Time</label>
                        <input type="text" id="focus_time_service" name="focus_time_service"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                    </div>
                </div>
            </div>

            <!-- Etiquetas de Color -->
            <div class="space-y-3">
                <div class="flex items-center">
                    <input type="checkbox" id="use_color_tags" name="use_color_tags"
                           class="h-3.5 w-3.5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="use_color_tags" class="ml-2 block text-xs text-gray-900">
                        Usar Etiquetas de Color
                    </label>
                </div>

                <div id="color_tags_container" class="space-y-3 hidden">
                    <div class="space-y-3" id="color_tags_list">
                    </div>
                    <button type="button" onclick="addColorTag()"
                            class="inline-flex items-center px-2.5 py-1 border border-transparent text-xs font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Añadir Etiqueta
                    </button>
                </div>
            </div>

            <div class="pt-4">
                <button type="button" onclick="saveConfig()"
                        class="inline-flex justify-center py-1 px-3 border border-transparent shadow-sm text-xs font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Guardar Configuración
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Toast de éxito -->
<div id="successToast" class="fixed bottom-4 right-4 hidden">
    <div class="bg-green-100 border border-green-400 text-green-700 px-3 py-2 rounded relative text-xs" role="alert">
        <span class="block sm:inline">Configuración guardada correctamente</span>
        <span class="absolute top-0 bottom-0 right-0 px-3 py-2" onclick="hideToast('successToast')">
            <svg class="fill-current h-4 w-4 text-green-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                <title>Close</title>
                <path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/>
            </svg>
        </span>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para el selector de colores personalizado */
    .custom-select-container {
        position: relative;
        width: 100%;
    }
    
    .custom-select-button {
        display: flex;
        align-items: center;
        width: 100%;
        text-align: left;
        cursor: pointer;
        padding: 0.375rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background-color: #fff;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }
    
    .custom-select-button:focus {
        outline: none;
        border-color: #a5b4fc;
        box-shadow: 0 0 0 2px rgba(165, 180, 252, 0.5);
    }
    
    .custom-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 20;
        width: 100%;
        max-height: 15rem;
        overflow-y: auto;
        background-color: #fff;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        margin-top: 0.25rem;
        display: none;
    }
    
    .custom-select-option {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        cursor: pointer;
    }
    
    .custom-select-option:hover {
        background-color: #f3f4f6;
    }
    
    .color-dot {
        display: inline-block;
        width: 0.75rem;
        height: 0.75rem;
        border-radius: 50%;
        border: 1px solid #e5e7eb;
        margin-right: 0.5rem;
    }
    
    /* Para inputs estándar */
    select, input[type="text"], input[type="time"] {
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Colores disponibles
const colorOptions = {
    '1': { name: 'Lavanda', color: '#a4bdfc' },
    '2': { name: 'Salvia', color: '#7ae7bf' },
    '3': { name: 'Uva', color: '#dbadff' },
    '4': { name: 'Flamingo', color: '#ff887c' },
    '5': { name: 'Banana', color: '#fbd75b' },
    '6': { name: 'Mandarina', color: '#ffb878' },
    '7': { name: 'Pavo Real', color: '#46d6db' },
    '8': { name: 'Grafito', color: '#e1e1e1' },
    '9': { name: 'Arándano', color: '#5484ed' },
    '10': { name: 'Albahaca', color: '#51b749' },
    '11': { name: 'Tomate', color: '#dc2127' }
};

// Cargar configuración al iniciar
document.addEventListener('DOMContentLoaded', function() {
    const config = JSON.parse(localStorage.getItem('calendarConfig') || '{}');
    
    // Cargar valores por defecto si no hay configuración
    if (!config.work_start_time) config.work_start_time = '09:00';
    if (!config.work_end_time) config.work_end_time = '18:00';
    if (!config.default_service) config.default_service = 'SERVICIO PRINCIPAL';
    if (!config.ooo_service) config.ooo_service = 'FUERA DE OFICINA';
    if (!config.focus_time_service) config.focus_time_service = 'TIEMPO DE CONCENTRACIÓN';
    if (!config.use_color_tags) config.use_color_tags = false;
    if (!config.color_tags) config.color_tags = {};

    // Establecer valores en los campos
    document.getElementById('work_start_time').value = config.work_start_time;
    document.getElementById('work_end_time').value = config.work_end_time;
    document.getElementById('default_service').value = config.default_service;
    document.getElementById('ooo_service').value = config.ooo_service;
    document.getElementById('focus_time_service').value = config.focus_time_service;
    document.getElementById('use_color_tags').checked = config.use_color_tags;
    
    // Mostrar/ocultar contenedor de etiquetas
    toggleColorTags();
    
    // Cargar etiquetas de color
    const colorTagsList = document.getElementById('color_tags_list');
    colorTagsList.innerHTML = '';
    for (const [colorId, serviceName] of Object.entries(config.color_tags)) {
        addColorTag(colorId, serviceName);
    }
});

function toggleColorTags() {
    const container = document.getElementById('color_tags_container');
    const checkbox = document.getElementById('use_color_tags');
    container.classList.toggle('hidden', !checkbox.checked);
}

function addColorTag(colorId = '', serviceName = '') {
    const container = document.getElementById('color_tags_list');
    const newTag = document.createElement('div');
    newTag.className = 'flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-3 border-b pb-3 mb-3 border-gray-100';
    
    // Contenedor del select personalizado
    const selectContainer = document.createElement('div');
    selectContainer.className = 'w-full sm:w-1/3 custom-select-container';
    
    // Crear un input oculto para almacenar el valor real
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'color_id[]';
    hiddenInput.value = colorId || '1';
    selectContainer.appendChild(hiddenInput);
    
    // Botón que muestra el valor seleccionado
    const selectButton = document.createElement('button');
    selectButton.type = 'button';
    selectButton.className = 'custom-select-button text-sm';
    selectButton.setAttribute('aria-haspopup', 'listbox');
    selectButton.setAttribute('aria-expanded', 'false');
    
    // Dropdown de opciones
    const dropdown = document.createElement('div');
    dropdown.className = 'custom-select-dropdown';
    dropdown.setAttribute('role', 'listbox');
    
    // Añadir opciones de color al dropdown
    for (const [id, color] of Object.entries(colorOptions)) {
        const option = document.createElement('div');
        option.className = 'custom-select-option';
        option.setAttribute('data-value', id);
        option.setAttribute('role', 'option');
        
        const colorDot = document.createElement('span');
        colorDot.className = 'color-dot';
        colorDot.style.backgroundColor = color.color;
        
        option.appendChild(colorDot);
        option.appendChild(document.createTextNode(color.name));
        
        // Al hacer clic en una opción
        option.addEventListener('click', function() {
            hiddenInput.value = id;
            updateCustomSelectButton(selectButton, id);
            dropdown.style.display = 'none';
            selectButton.setAttribute('aria-expanded', 'false');
        });
        
        dropdown.appendChild(option);
    }
    
    // Eventos para abrir/cerrar el dropdown
    selectButton.addEventListener('click', function() {
        const isExpanded = selectButton.getAttribute('aria-expanded') === 'true';
        if (isExpanded) {
            dropdown.style.display = 'none';
            selectButton.setAttribute('aria-expanded', 'false');
        } else {
            dropdown.style.display = 'block';
            selectButton.setAttribute('aria-expanded', 'true');
            
            // Posicionar correctamente el dropdown
            const buttonRect = selectButton.getBoundingClientRect();
            if (buttonRect.bottom + 300 > window.innerHeight) {
                dropdown.style.bottom = '100%';
                dropdown.style.top = 'auto';
                dropdown.style.marginTop = '0';
                dropdown.style.marginBottom = '0.25rem';
            } else {
                dropdown.style.top = '100%';
                dropdown.style.bottom = 'auto';
                dropdown.style.marginBottom = '0';
                dropdown.style.marginTop = '0.25rem';
            }
        }
    });
    
    // Cerrar el dropdown al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!selectContainer.contains(e.target)) {
            dropdown.style.display = 'none';
            selectButton.setAttribute('aria-expanded', 'false');
        }
    });
    
    selectContainer.appendChild(selectButton);
    selectContainer.appendChild(dropdown);
    
    // Contenedor del input de texto
    const inputContainer = document.createElement('div');
    inputContainer.className = 'w-full sm:flex-1';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'service_name[]';
    input.value = serviceName;
    input.placeholder = 'Nombre del Servicio';
    input.className = 'block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm';
    
    inputContainer.appendChild(input);
    
    // Contenedor del botón de eliminar
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'flex justify-end sm:justify-start sm:mt-0 mt-2';
    
    // Botón para eliminar
    const removeButton = document.createElement('button');
    removeButton.type = 'button';
    removeButton.className = 'text-red-600 hover:text-red-800';
    removeButton.onclick = function() { removeColorTag(this); };
    removeButton.innerHTML = `
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
    `;
    
    buttonContainer.appendChild(removeButton);
    
    // Añadir todos los elementos al contenedor principal
    newTag.appendChild(selectContainer);
    newTag.appendChild(inputContainer);
    newTag.appendChild(buttonContainer);
    container.appendChild(newTag);
    
    // Actualizar el botón con el valor inicial
    updateCustomSelectButton(selectButton, hiddenInput.value);
}

// Actualiza el texto y el color en el botón del select personalizado
function updateCustomSelectButton(button, colorId) {
    const color = colorOptions[colorId];
    if (!color) return;
    
    button.innerHTML = '';
    
    const colorDot = document.createElement('span');
    colorDot.className = 'color-dot';
    colorDot.style.backgroundColor = color.color;
    
    button.appendChild(colorDot);
    button.appendChild(document.createTextNode(color.name));
}

function removeColorTag(button) {
    // Subir dos niveles para llegar al div del tag completo
    const colorTag = button.closest('[class*="flex flex-col sm:flex-row"]');
    if (colorTag) {
        colorTag.remove();
    }
}

function showToast(toastId) {
    const toast = document.getElementById(toastId);
    toast.classList.remove('hidden');
    setTimeout(() => hideToast(toastId), 3000);
}

function hideToast(toastId) {
    const toast = document.getElementById(toastId);
    toast.classList.add('hidden');
}

function saveConfig() {
    const config = {
        work_start_time: document.getElementById('work_start_time').value,
        work_end_time: document.getElementById('work_end_time').value,
        default_service: document.getElementById('default_service').value,
        ooo_service: document.getElementById('ooo_service').value,
        focus_time_service: document.getElementById('focus_time_service').value,
        use_color_tags: document.getElementById('use_color_tags').checked,
        color_tags: {}
    };

    // Recolectar etiquetas de color
    const colorTags = document.querySelectorAll('#color_tags_list > div');
    colorTags.forEach(tag => {
        const colorId = tag.querySelector('input[type="hidden"]').value;
        const serviceName = tag.querySelector('input[type="text"]').value;
        if (colorId && serviceName) {
            config.color_tags[colorId] = serviceName;
        }
    });

    // Guardar en localStorage
    localStorage.setItem('calendarConfig', JSON.stringify(config));
    
    // Mostrar toast de éxito
    showToast('successToast');
}

document.getElementById('use_color_tags').addEventListener('change', toggleColorTags);
</script>
{% endblock %} 